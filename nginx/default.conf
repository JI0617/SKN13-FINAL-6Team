upstream backend { server backend:8000; }

server {
  listen 80;
  server_name api.growing.ai.kr;

  location /health { add_header Content-Type text/plain; return 200 "ok\n"; }

  client_max_body_size 50m;

  # (선택 1) 프리플라이트를 Nginx에서 즉시 204로 응답 — Django와 중복 금지!
  if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Origin "https://www.growing.ai.kr";
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS";
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept, Origin";
    add_header Access-Control-Allow-Credentials "true";
    return 204;
  }

  location / {
    proxy_pass http://backend;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto; # ALB가 준 값 신뢰
    proxy_read_timeout 300;
  }
}
