# ---------- http 컨텍스트(서버블록 밖) ----------
# 허용 Origin만 되돌려주고, 아니면 빈 값
map $http_origin $cors_allow_origin {
    default "";
    "~^https://(www\.)?growing\.ai\.kr$" $http_origin;
}

# ---------- 서버블록 ----------
upstream backend {
    server backend:8000;
}

server {
    listen 80;
    server_name api.growing.ai.kr;

    # 헬스체크
    location = /health {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    # API
    location / {
        # Preflight
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $cors_allow_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept, Origin" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Vary "Origin" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        # 백엔드가 내려보내는 CORS 헤더는 숨김(중복 방지)
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Access-Control-Expose-Headers;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header Access-Control-Allow-Methods;

        proxy_pass http://backend;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto; # ALB가 보낸 proto 유지
        proxy_read_timeout 300;

        # 실요청에도 CORS (정확히 1회만)
        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Vary "Origin" always;
    }
}
