# upstream 정의
upstream backend {
    server backend:8000;
}

# http 블록
map $http_origin $cors_allow_origin {
    default "";
    "~^https://(www\.)?growing\.ai\.kr$" $http_origin;
}

server {
    listen 80;
    server_name api.growing.ai.kr;

    location = /health {
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    location / {
        # 프리플라이트는 Nginx가 직접 응답
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin $cors_allow_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept, Origin" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Vary "Origin" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        # ✅ 백엔드가 보내는 CORS 헤더를 전부 숨김(대소문자 모두)
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header access-control-allow-origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header access-control-allow-credentials;
        proxy_hide_header Access-Control-Expose-Headers;
        proxy_hide_header access-control-expose-headers;
        proxy_hide_header Access-Control-Allow-Headers;
        proxy_hide_header access-control-allow-headers;
        proxy_hide_header Access-Control-Allow-Methods;
        proxy_hide_header access-control-allow-methods;

        proxy_pass http://backend;

        # ⬇ Host를 API 도메인으로 고정(DisallowedHost 방지에 도움)
        proxy_set_header Host api.growing.ai.kr;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
        proxy_read_timeout 300;

        # 실요청에도 Nginx가 '정확히 1회만' CORS 추가
        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Vary "Origin" always;
    }
}
